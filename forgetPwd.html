<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>忘记密码</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.2.0.css" />
    <link rel="stylesheet" type="text/css" href="../css/font.css" />
    <link rel="stylesheet" type="text/css" href="../css/login.css" />
</head>

<body>
    <div class="container" style="margin-top: .93rem;">
        <div style="width: 5.25rem;height: 5.25rem;margin: 0 auto;">
            <img src="../image/logo.png" alt="logo" style="height:100%;">
        </div>
        <div class="login-title pingfangRegular">夫子医</div>
        <div class="aui-content-padded">
            <div class="inputBox-bar pingfangRegular" style="margin-bottom: .75rem;">
                <div class="inputBox-bar-name aui-clearfix">
                    <div class="phoneNum float-l">手&nbsp;机&nbsp;号</div>
                </div>
                <div class="inputBox-bar-input">
                    <input type="tel" maxlength="11" id="phone" class="color-66 pingfangRegular tel_">
                </div>
            </div>
            <div class="inputBox-bar pingfangRegular" style="margin-bottom: .75rem;">
                <div class="inputBox-bar-name aui-clearfix">
                    <div class="phoneNum float-l">验&nbsp;证&nbsp;码</div>
                </div>
                <div class="inputBox-bar-input">
                    <input type="number" id="code" class="code-input color-66 pingfangRegular">
                    <div id="getCode" class="aui-btn getCode-btn color-66 pingfangRegular">获&nbsp;取&nbsp;验&nbsp;证&nbsp;码</div>
                </div>
            </div>
            <div class="inputBox-bar pingfangRegular" style="margin-bottom: .75rem;">
                <div class="inputBox-bar-name aui-clearfix">
                    <div class="phoneNum float-l">重&nbsp;置&nbsp;密&nbsp;码</div>
                </div>
                <div class="inputBox-bar-input">
                    <input type="text" id="password" class="color-66 pingfangRegular">
                </div>
            </div>
            <div class="btnBox pingfangRegular" style="margin-top: 1.9rem;">
                <div class="aui-btn aui-btn-block login-btn" id="submit">提&nbsp;交</div>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript">
    apiready = function() {
        console.log(api.frameName);
        var container = $api.dom('.container');
        container.style.paddingTop = api.safeArea.top + 'px';
        container.style.paddingBottom = api.safeArea.bottom + 'px';
    };
    // ------------获取验证码----------------
    var getCode = $api.byId('getCode');
    var countdown = 60;
    var intervalFun;
    var btnS = 1;

    $api.addEvt(getCode, 'click', function() {
        if (btnS == 1) {
            btnS = 2;
        } else {
            return false;
        }
        settime();
        var phone = $api.val($api.byId('phone'));
        if (phone == '') {
            api.alert({
                title: '提示',
                msg: '手机号不能为空'
            });
            return false;
        } else {
            api.ajax({
                url: 'http://doctor.show.chinanet.asia/index.php/Home/User/forget',
                method: 'get',
                data: {
                    values: {
                        phone: phone
                    }
                }
            }, function(ret, err) {
                // console.log(JSON.stringify(ret));
                if (ret.status == 20000) {
                    api.alert({
                        title: '提示',
                        msg: ret.msg
                    });
                    return false;
                } else {
                    if (countdown < 60) {
                        return false;
                    } else {
                        settime();
                    }
                }
            })
        }
    });

    function settime() {
        if (countdown == 0) {
            // $api.rmEvt(getCode, 'click');
            $api.html(getCode, "获&nbsp;取&nbsp;验&nbsp;证&nbsp;码");
            countdown = 60;
            btnS = 1;
            return false;
        } else {
            $api.html(getCode, "重&nbsp;新&nbsp;发&nbsp;送&nbsp;(" + countdown + ")");
            countdown--;
        }

        setTimeout(function() {
            settime();
        }, 1000);
    }


    var submit = $api.byId('submit');
    $api.addEvt(submit, 'click', function() {
        var phone = $api.val($api.byId('phone'));
        var code = $api.val($api.byId('code'));
        var password = $api.val($api.byId('password'));
        if (phone == '') {
            api.alert({
                title: '提示',
                msg: '手机号不能为空'
            });
            return false;
        } else if (code == '') {
            api.alert({
                title: '提示',
                msg: '验证码不能为空'
            });
            return false;
        } else if (password == '') {
            api.alert({
                title: '提示',
                msg: '密码不能不能为空'
            });
            return false;
        }
        // console.log(phone);
        // console.log(code);
        // console.log(password);

        api.ajax({
            url: 'http://doctor.show.chinanet.asia/index.php/home/user/forgetDo',
            method: 'post',
            data: {
                values: {
                    phone: phone,
                    code: code,
                    password: password
                }
            }
        }, function(ret, err) {
            // console.log(ret.status);
            // console.log(JSON.stringify(ret));
            if (ret.status == 20000) {
                api.alert({
                    title: '提示',
                    msg: ret.msg
                });

            } else {
                api.alert({
                    title: '提示',
                    msg: '密码重置成功!'
                });
                $api.setStorage('uid', ret.info.uid);
                api.openWin({
                    name: 'index',
                    url: '../index.html'
                });
            }

        });
    })
</script>

</html>
